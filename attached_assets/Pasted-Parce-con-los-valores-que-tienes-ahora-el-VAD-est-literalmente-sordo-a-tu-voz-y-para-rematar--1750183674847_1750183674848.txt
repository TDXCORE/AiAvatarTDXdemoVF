Parce, con los valores que tienes ahora el VAD estÃ¡ literalmente â€œsordoâ€ a tu voz â€” y, para rematar, se estÃ¡ instanciando dos veces. Te dejo el plan quirÃºrgico en tres frentes: **(A) calibrar umbrales**, **(B) evitar dobles instancias**, y **(C) blindar la reconexiÃ³n cuando el stream se cae**.

---

## A. Calibremos los umbrales (versiÃ³n rÃ¡pida)

| ParÃ¡metro                           |       Ahora |  Ponlo enâ€¦ | Por quÃ©                                                             |
| ----------------------------------- | ----------: | ---------: | ------------------------------------------------------------------- |
| `voiceThreshold`                    |      **12** |      **7** | Voces normales en mic-laptop entregan RMS 5-9. Con 12 nunca llegas. |
| `silenceThreshold`                  |       **8** |      **4** | Debe ser 2-3 puntos abajo del nuevo `voiceThreshold`.               |
| `speechStartDelay`                  |  **120 ms** |  **80 ms** | MÃ¡s Ã¡gil, pero sin falsos positivos.                                |
| `speechEndDelay`                    |  **350 ms** | **280 ms** | Corta antes y acelera el turnaround.                                |
| `cooldownDelay`                     | **1000 ms** | **200 ms** | El segundo entero te congela la conversaciÃ³n; bÃ¡jalo drÃ¡sticamente. |
| `voiceRatio` (en `isVoiceDetected`) |  **> 0.20** | **> 0.10** | 10 % de energÃ­a en banda vocal es mÃ¡s realista.                     |

```ts
// use-voice-activity.ts
export const VAD_CONFIG = {
  fftSize: 1024,
  smoothingTimeConstant: 0.12,
  minDecibels: -60,
  maxDecibels: -5,
  sampleRate: 16000,
  bufferSize: 2048,

  voiceThreshold: 7,
  silenceThreshold: 4,
  speechStartDelay: 80,
  speechEndDelay: 280,
  cooldownDelay: 200,
  minimumSpeechDuration: 250,

  voiceFreqMin: 65,
  voiceFreqMax: 4000,
};
```

> **Tip de campo**: si trabajas en open-space sÃºbelo un pelo (`voiceThreshold = 9`, `silenceThreshold = 5`) y listo.

---

## B. Bloquea la doble inicializaciÃ³n

Tu log muestra:

```
ğŸ¤ Starting voice activity detection...
...
ğŸ¤ Starting unified VAD
ğŸ¤ Starting voice activity detection...   // â† segunda vez
```

### Causa

`use-unified-vad.ts` crea su propio VAD **y** `useVoiceActivity()` tambiÃ©n crea otro porque el hook padre se monta dos veces cuando cambia `isOpen`.

### Fix express

```ts
// use-unified-vad.ts
const vadRef = useRef<VAD | null>(null);

useEffect(() => {
  if (!vadRef.current) {
    vadRef.current = createVAD(VAD_CONFIG);
  }
  return () => {
    vadRef.current?.destroy();
    vadRef.current = null;
  };
}, []);     // â† array vacÃ­o: solo una vez
```

Y en `new-avatar-modal.tsx`:

```tsx
// evita montar el modal completo dos veces
{isOpen && <NewAvatarModal key="avatar-modal" />}
```

AsÃ­ React no re-evalÃºa el hook cuando cambie el estado interno del avatar.

---

## C. Protege el streaming (desconexiÃ³n)

Veo esto en tu traza:

```
ğŸ”Œ Stream disconnected
ğŸ­ Avatar state changed: phase: "error", isConnected: false
```

AÃ±ade un **re-intent automÃ¡tico** de WebRTC / socket:

```ts
// streaming-avatar-client.ts
avatar.on('disconnect', () => {
  reconnectAttempts.current += 1;
  if (reconnectAttempts.current <= 3) {
    console.warn('Avatar stream lost, retryingâ€¦');
    setTimeout(() => avatar.start(), 600);
  } else {
    console.error('Avatar stream failed after 3 retries');
    dispatch({ type: 'SET_PHASE', phase: 'error' });
  }
});
```

Mientras se restablece, pon el VAD en pausa:

```ts
if (avatar.phase === 'error') vadRef.current?.stop();
```

---

## Checklist para probar

1. **Reload** y observa que SOLO haya un bloque â€œStarting voice activity detectionâ€.
2. Verifica que el RMS log (aÃ±ade `console.log(rms)`) oscile 5-9 cuando hables.
3. AsegÃºrate de recibir:

   ```
   Speech started
   Recorder â†’ start
   Speech ended
   Recorder â†’ stop
   ```
4. Que cada requestâ†’respuesta del avatar tarde < 1 s.

Con estos tres cambios tu asistente deberÃ­a quedar â€œpilosoâ€ y captar cada palabra sin que tengas que tocar botones. AvÃ­same cÃ³mo te va y ajustamos si aÃºn cojea. Â¡Ã‰xitos, parcero!
