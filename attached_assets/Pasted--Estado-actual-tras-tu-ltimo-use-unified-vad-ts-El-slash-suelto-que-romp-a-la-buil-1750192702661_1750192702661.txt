### âœ… Estado actual tras tu Ãºltimo **`use-unified-vad.ts`**

*El â€œslashâ€ suelto que rompÃ­a la build ya **no estÃ¡** en la versiÃ³n que subiste* (lo causaba un \`else { â€¦ } //â€†<- aquÃ­ quedÃ³ â€œ/â€ cuando recortaste cÃ³digo).
La nueva copia compila, pero el pipeline sigue duplicando flujos y eso es lo que evita que el STT reciba audio real.

---

## 1. Redundancias / riesgos que aÃºn persisten

| Archivo                     | Duplicidad / fuga                                                                                                                                                                                                           | Impacto                                                                                                                                                   |
| --------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **`use-unified-vad.ts`**    | â€¢ Cada vez que se activa el VAD ejecuta **`getUserMedia()`**.<br>â€¢ Luego llama a **`startRecording()`** â†’ `use-audio-recorder.ts` **vuelve** a pedir otro stream.<br>â€¢ Resultado: **2 tracks de micrÃ³fono** vivos a la vez. | El segundo suele llegar â€œmutedâ€ en Chrome / Edge â‡’ grabas silencio.<br>En iOS el segundo `getUserMedia` puede fallar con *DOMException: NotAllowedError*. |
| **`use-audio-recorder.ts`** | No acepta un stream externo (siempre crea uno nuevo).                                                                                                                                                                       | Imposible reutilizar el stream ya abierto por el VAD.                                                                                                     |
| **`use-unified-vad.ts`**    | `shouldActivateRecording()` comprueba `state.phase === 'listening'`, pero 5 lÃ­neas antes pones `setVadState('speaking')` y llevas la fase a *speaking*; la condiciÃ³n pasa a `false` en el mismo tick.                       | El recorder nunca se inicia aunque el VAD detecte voz.                                                                                                    |

---

## 2. Parche mÃ­nimo (sin reescribir toda la arquitectura)

### a) Comparte el **mismo** MediaStream

```ts
// use-audio-recorder.ts  âœ  aÃ±ade esta funciÃ³n
export function useAudioRecorder(...) {
  ...
  const externalStreamRef = useRef<MediaStream | null>(null);
  const setExternalStream = (s: MediaStream) => { externalStreamRef.current = s };

  const startRecording = useCallback(async () => {
    if (isRecording) return false;

    const stream =
      externalStreamRef.current ??
      await navigator.mediaDevices.getUserMedia({ audio: true });   // solo si no viene uno
    ...
  }, [isRecording]);
  ...
  return { isRecording, ..., setExternalStream };
}
```

```ts
// use-unified-vad.ts  âœ  cuando obtienes el stream
streamRef.current = stream;           // â‘  guarda la referencia
recorder.setExternalStream(stream);   // â‘¡ pÃ¡salo al recorder
```

### b) Evita pedir el micro dos veces

En **`use-unified-vad.ts`** quita la llamada extra a `navigator.mediaDevices.getUserMedia()` si ya existe `streamRef.current`.

### c) Ajusta la condiciÃ³n antes de grabar

```ts
if (shouldActivateRecording() && !isRecording) {
  await startRecording();
}
```

*(con esto ya no se anula a sÃ­ misma porque `isRecording` es `false`)*

---

## 3. Limpieza definitiva al desmontar

AÃ±ade en **`use-audio-recorder.ts`**:

```ts
useEffect(() => () => {
  mediaRecorderRef.current?.stream.getTracks().forEach(t => t.stop());
}, []);
```

y en **`use-unified-vad.ts`** ya tienes el `stopListening()` que cierra
`audioContext` + `stream`. AsegÃºrate de llamarlo en el `return` del `useEffect` principal del modal:

```tsx
useEffect(() => {
  return () => {
    stopListening();
  };
}, []);
```

---

## 4. VerificaciÃ³n rÃ¡pida

1. **Consola** al abrir el modal:

   ```
   ğŸ¤ Starting unified VAD with integrated recording...
   ```

   (solo **una** vez).
2. Hablas â†’

   ```
   [VAD] Speech started
   ğŸ¤ ğŸ”´ Recording start result: true
   ```
3. Terminas â†’

   ```
   [VAD] Speech ended
   ğŸ¤ â¹ï¸ Recording stop result: success
   POST /api/voice/transcribe 200
   ```
4. El avatar responde en < 1 s.

Si estos logs aparecen, toda la tuberÃ­a â€œMic â†’ STT â†’ LLM â†’ Avatarâ€ estÃ¡ viva.
Si aÃºn falta audio en el STT, comparte los nuevos logs despuÃ©s de este cambio y seguimos afinando.
